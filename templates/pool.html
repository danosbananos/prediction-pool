{% extends "base.html" %}

{% block title %}{{ pool.name }}{% endblock %}
{% block header %}{{ pool.name }}{% endblock %}
{% block subheader %}
    <span class="status-badge status-{{ pool.status }}">{{ pool.status }}</span>
    {% if pool.description %}<br>{{ pool.description }}{% endif %}
{% endblock %}

{% block user_bar %}
{% if me %}
<div class="user-bar">
    <span>{{ me.display_name }}</span>
    <form method="post" action="{{ url_for('logout', pool_id=pool.id) }}">
        <button type="submit" class="btn-sign-out">Sign Out</button>
    </form>
</div>
{% endif %}
{% endblock %}

{% block content %}

{# --- Share link --- #}
<div class="pool-link-box">
    <input type="text" id="pool-url" value="{{ request.url_root }}pool/{{ pool.id }}" readonly onclick="this.select()">
    <button class="btn btn-outline btn-sm" onclick="copyLink()">Copy</button>
</div>

{# --- Winner banner --- #}
{% if pool.status == 'finished' and leaderboard %}
<div class="winner-banner">
    <div class="trophy">üèÜ</div>
    <h2>{{ leaderboard[0].display_name }} wins!</h2>
    <p>{{ leaderboard[0].score() }} pts</p>
</div>
{% endif %}

{# --- Action bar --- #}
{% if not me %}
<div class="actions-bar">
    <a href="{{ url_for('join_pool', pool_id=pool.id) }}" class="btn btn-primary btn-sm">Join Pool</a>
    <a href="{{ url_for('signin', pool_id=pool.id) }}" class="btn btn-outline btn-sm">Sign Back In</a>
</div>
{% endif %}

{# --- Tab Bar --- #}
<div class="tab-bar">
    <button class="tab-btn active" data-tab="tab-predictions" onclick="switchTab('tab-predictions')">My Predictions</button>
    <button class="tab-btn" data-tab="tab-pool" onclick="switchTab('tab-pool')">Pool</button>
</div>

{# ================================================================== #}
{# TAB 1 ‚Äî MY PREDICTIONS                                             #}
{# ================================================================== #}
<div id="tab-predictions" class="tab-panel active">

{# --- Matches + Predictions --- #}
{% if pool.matches %}
<div class="section-title">Matches</div>

{% if me and pool.status == 'open' %}
<form method="post" action="{{ url_for('save_predictions', pool_id=pool.id) }}">
{% endif %}

{% for match in pool.matches %}
<div class="match-card {% if match.result %}has-result{% endif %}">
    <div class="match-header">
        <span class="match-label">Match {{ loop.index }}</span>
        <span class="match-points">√ó{{ match.multiplier }}</span>
    </div>
    <div class="fighters">
        {% set my_pick = my_predictions.get(match.id) %}

        {# Fighter A button #}
        {% if me and pool.status == 'open' %}
            <button type="button" class="fighter-btn {% if my_pick == 'a' %}selected{% endif %}"
                    onclick="togglePick(this, '{{ match.id }}', 'a')">
                <div class="fighter-cell">
                    {% if match.fighter_a_image %}
                        <img src="{{ match.fighter_a_image }}" alt="{{ match.participant_a }}" class="fighter-photo">
                    {% endif %}
                    <span>{{ match.fighter_a_flag or '' }} {{ match.participant_a }}</span>
                    {% if match.odds_a %}
                        <span class="odds-badge">{{ '%.2f'|format(match.odds_a) }}</span>
                    {% endif %}
                    {% if match.fighter_a_record %}
                        <span class="fighter-meta"><span class="record">{{ match.fighter_a_record }}</span></span>
                    {% endif %}
                </div>
            </button>
        {% else %}
            <div class="fighter-btn
                {% if match.result == 'a' %}winner-highlight{% endif %}
                {% if my_pick == 'a' and match.result == 'a' %}correct{% elif my_pick == 'a' and match.result and match.result != 'a' %}wrong{% elif my_pick == 'a' %}selected{% endif %}"
                {% if not me and pool.status == 'open' %}onclick="showSignInToast()"{% endif %}>
                <div class="fighter-cell">
                    {% if match.fighter_a_image %}
                        <img src="{{ match.fighter_a_image }}" alt="{{ match.participant_a }}" class="fighter-photo">
                    {% endif %}
                    <span>{{ match.fighter_a_flag or '' }} {{ match.participant_a }}</span>
                    {% if match.odds_a %}
                        <span class="odds-badge">{{ '%.2f'|format(match.odds_a) }}</span>
                    {% endif %}
                    {% if match.fighter_a_record %}
                        <span class="fighter-meta"><span class="record">{{ match.fighter_a_record }}</span></span>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <span class="vs">VS</span>

        {# Fighter B button #}
        {% if me and pool.status == 'open' %}
            <button type="button" class="fighter-btn {% if my_pick == 'b' %}selected{% endif %}"
                    onclick="togglePick(this, '{{ match.id }}', 'b')">
                <div class="fighter-cell">
                    {% if match.fighter_b_image %}
                        <img src="{{ match.fighter_b_image }}" alt="{{ match.participant_b }}" class="fighter-photo">
                    {% endif %}
                    <span>{{ match.fighter_b_flag or '' }} {{ match.participant_b }}</span>
                    {% if match.odds_b %}
                        <span class="odds-badge">{{ '%.2f'|format(match.odds_b) }}</span>
                    {% endif %}
                    {% if match.fighter_b_record %}
                        <span class="fighter-meta"><span class="record">{{ match.fighter_b_record }}</span></span>
                    {% endif %}
                </div>
            </button>
        {% else %}
            <div class="fighter-btn
                {% if match.result == 'b' %}winner-highlight{% endif %}
                {% if my_pick == 'b' and match.result == 'b' %}correct{% elif my_pick == 'b' and match.result and match.result != 'b' %}wrong{% elif my_pick == 'b' %}selected{% endif %}"
                {% if not me and pool.status == 'open' %}onclick="showSignInToast()"{% endif %}>
                <div class="fighter-cell">
                    {% if match.fighter_b_image %}
                        <img src="{{ match.fighter_b_image }}" alt="{{ match.participant_b }}" class="fighter-photo">
                    {% endif %}
                    <span>{{ match.fighter_b_flag or '' }} {{ match.participant_b }}</span>
                    {% if match.odds_b %}
                        <span class="odds-badge">{{ '%.2f'|format(match.odds_b) }}</span>
                    {% endif %}
                    {% if match.fighter_b_record %}
                        <span class="fighter-meta"><span class="record">{{ match.fighter_b_record }}</span></span>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {% if me and pool.status == 'open' %}
            <input type="hidden" name="match_{{ match.id }}" id="pick_{{ match.id }}" value="{{ my_pick or '' }}">
        {% endif %}
    </div>

    {# Potential score display #}
    {% if match.odds_a or match.odds_b %}
    <div class="potential-score">
        {% if match.odds_a %}{{ match.participant_a }}: {{ match.potential_score('a') }} pts{% endif %}
        {% if match.odds_a and match.odds_b %} ¬∑ {% endif %}
        {% if match.odds_b %}{{ match.participant_b }}: {{ match.potential_score('b') }} pts{% endif %}
    </div>
    {% endif %}

    {# Prediction counts #}
    {% set summary = pred_summary.get(match.id, {'a': 0, 'b': 0}) %}
    {% if pool.participants|length > 0 %}
    <div class="picks-detail">
        {{ summary.a }} picked {{ match.participant_a }} ¬∑ {{ summary.b }} picked {{ match.participant_b }}
    </div>
    {% endif %}

    {# Result display (read-only on Predictions tab) #}
    {% if match.result %}
        <div class="picks-detail">
            <strong>Winner:
            {% if match.result == 'a' %}{{ match.participant_a }}
            {% elif match.result == 'b' %}{{ match.participant_b }}
            {% else %}Draw{% endif %}</strong>
        </div>
    {% endif %}
</div>
{% endfor %}

{% if me and pool.status == 'open' %}
    <button type="submit" class="btn btn-primary btn-full mt-1">Save My Predictions</button>
</form>
{% endif %}

{% else %}
<p class="mt-2" style="color: var(--text-muted);">No matches yet. <a href="#" onclick="switchTab('tab-pool'); return false;">Add some matches</a> to get started.</p>
{% endif %}

{# --- All picks (visible when locked/finished) --- #}
{% if pool.status in ('locked', 'finished') and pool.participants and pool.matches %}
<div class="section-title">Everyone's Picks</div>
<div class="overflow-x">
<table>
    <thead>
        <tr>
            <th style="text-align:left;">Match</th>
            {% for p in leaderboard %}
            <th>{{ p.display_name }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for match in pool.matches %}
        <tr>
            <td>{{ match.participant_a }} vs {{ match.participant_b }}</td>
            {% for p in leaderboard %}
                {% set pick = all_predictions.get(p.id, {}).get(match.id) %}
                <td>
                    {% if pick == 'a' %}
                        <span {% if match.result == 'a' %}style="color:var(--green);font-weight:700;"{% elif match.result and match.result != 'a' %}style="color:var(--red-wrong);text-decoration:line-through;"{% endif %}>
                            {{ match.participant_a }}
                        </span>
                    {% elif pick == 'b' %}
                        <span {% if match.result == 'b' %}style="color:var(--green);font-weight:700;"{% elif match.result and match.result != 'b' %}style="color:var(--red-wrong);text-decoration:line-through;"{% endif %}>
                            {{ match.participant_b }}
                        </span>
                    {% else %}
                        ‚Äî
                    {% endif %}
                </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>
{% endif %}

{# --- Leaderboard --- #}
{% if pool.participants %}
<div class="section-title">Leaderboard</div>
<div class="leaderboard">
    {% for p in leaderboard %}
    <div class="leaderboard-entry">
        <span class="leaderboard-rank">
            {% if loop.index == 1 and pool.status == 'finished' %}üèÜ{% else %}#{{ loop.index }}{% endif %}
        </span>
        <span class="leaderboard-name">
            {{ p.display_name }}
            {% if me and p.id == me.id %}<span class="you">(you)</span>{% endif %}
        </span>
        <span class="leaderboard-score">{{ p.score() }} pts</span>
    </div>
    {% endfor %}
</div>
{% endif %}

</div>{# end tab-predictions #}

{# ================================================================== #}
{# TAB 2 ‚Äî POOL                                                       #}
{# ================================================================== #}
<div id="tab-pool" class="tab-panel">

{# --- Pool status controls --- #}
<div class="pool-controls">
    <div class="actions-bar">
        {% if pool.status == 'open' %}
            <form method="post" action="{{ url_for('lock_pool', pool_id=pool.id) }}">
                <button type="submit" class="btn btn-secondary btn-sm" onclick="return confirm('Lock the pool? No more predictions will be allowed.')">Lock Pool</button>
            </form>
            <div class="hint">No one can change predictions after locking</div>
        {% elif pool.status == 'locked' %}
            <form method="post" action="{{ url_for('reopen_pool', pool_id=pool.id) }}">
                <button type="submit" class="btn btn-outline btn-sm">Reopen for Predictions</button>
            </form>
            {% if pool.all_results_entered %}
            <form method="post" action="{{ url_for('finish_pool', pool_id=pool.id) }}">
                <button type="submit" class="btn btn-primary btn-sm" onclick="return confirm('Finish the pool and declare a winner?')">Finish &amp; Declare Winner</button>
            </form>
            {% endif %}
        {% elif pool.status == 'finished' %}
            <form method="post" action="{{ url_for('reopen_pool', pool_id=pool.id) }}">
                <button type="submit" class="btn btn-outline btn-sm">Reopen Pool</button>
            </form>
        {% endif %}
    </div>
</div>

{# --- Result entry (when locked/finished) --- #}
{% if pool.status in ('locked', 'finished') and pool.matches %}
<div class="section-title">Enter Results</div>
{% for match in pool.matches %}
<div class="match-card {% if match.result %}has-result{% endif %}" style="padding: 0.75rem 1rem;">
    <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; flex-wrap: wrap;">
        <span style="font-family: var(--font-condensed); font-weight: 700; font-size: 0.82rem; text-transform: uppercase; letter-spacing: 0.03em;">
            {{ match.fighter_a_flag or '' }} {{ match.participant_a }} vs {{ match.participant_b }} {{ match.fighter_b_flag or '' }}
        </span>
        {% if match.result %}
            <span style="font-size: 0.78rem; color: var(--green); font-weight: 600;">
                Winner: {% if match.result == 'a' %}{{ match.participant_a }}{% elif match.result == 'b' %}{{ match.participant_b }}{% else %}Draw{% endif %}
            </span>
            <form method="post" action="{{ url_for('clear_result', pool_id=pool.id, match_id=match.id) }}" style="display:inline;">
                <button type="submit" class="btn btn-outline btn-sm" style="padding:0.15rem 0.4rem; font-size:0.7rem;">Clear</button>
            </form>
        {% else %}
            <div style="display: flex; gap: 0.35rem;">
                <form method="post" action="{{ url_for('enter_result', pool_id=pool.id, match_id=match.id) }}">
                    <input type="hidden" name="result" value="a">
                    <button type="submit" class="btn btn-outline btn-sm" style="padding:0.3rem 0.6rem; font-size:0.72rem;">{{ match.participant_a }} wins</button>
                </form>
                <form method="post" action="{{ url_for('enter_result', pool_id=pool.id, match_id=match.id) }}">
                    <input type="hidden" name="result" value="b">
                    <button type="submit" class="btn btn-outline btn-sm" style="padding:0.3rem 0.6rem; font-size:0.72rem;">{{ match.participant_b }} wins</button>
                </form>
            </div>
        {% endif %}
    </div>
</div>
{% endfor %}
{% endif %}

{# --- Admin match cards (accordion) --- #}
<div class="section-title">Matches ({{ pool.matches|length }})</div>

{% if pool.matches %}
<form method="post" action="{{ url_for('fetch_all_fighter_data', pool_id=pool.id) }}" style="margin-bottom: 1rem;">
    <button type="submit" class="btn btn-outline btn-sm">Fetch Missing Fighter Data</button>
</form>
{% endif %}

{% for match in pool.matches %}
<div class="admin-match-card" data-card-id="{{ match.id }}">
    <div class="admin-match-header" onclick="toggleAdminCard(this)">
        <span class="match-num">#{{ loop.index }}</span>
        <span class="fighter-names">
            {{ match.fighter_a_flag or '' }} {{ match.participant_a }} vs {{ match.participant_b }} {{ match.fighter_b_flag or '' }}
        </span>
        {% if match.odds_a %}<span class="odds-badge">{{ '%.2f'|format(match.odds_a) }}</span>{% endif %}
        {% if match.odds_b %}<span class="odds-badge">{{ '%.2f'|format(match.odds_b) }}</span>{% endif %}
        <span class="match-points">√ó{{ match.multiplier }}</span>
        <span class="chevron">‚ñº</span>
    </div>
    <div class="admin-match-body">
        {# Unified match editing form (names, odds, multiplier, fighter data) #}
        <form method="post" action="{{ url_for('edit_match', pool_id=pool.id, match_id=match.id) }}">
            <div class="admin-edit-grid">
                <div>
                    <label>Fighter A</label>
                    <input type="text" name="participant_a" value="{{ match.participant_a }}" placeholder="Fighter A">
                </div>
                <div>
                    <label>Fighter A Odds</label>
                    <input type="text" name="odds_a" value="{{ '%.2f'|format(match.odds_a) if match.odds_a else '' }}" placeholder="e.g. 1.50" inputmode="decimal">
                </div>
                <div>
                    <label>Fighter B</label>
                    <input type="text" name="participant_b" value="{{ match.participant_b }}" placeholder="Fighter B">
                </div>
                <div>
                    <label>Fighter B Odds</label>
                    <input type="text" name="odds_b" value="{{ '%.2f'|format(match.odds_b) if match.odds_b else '' }}" placeholder="e.g. 2.80" inputmode="decimal">
                </div>
            </div>
            <label>Multiplier</label>
            <input type="number" name="multiplier" value="{{ match.multiplier }}" min="1" style="max-width: 5rem;">

            {# Fighter data fields #}
            <div style="margin-top: 0.75rem; border-top: 1px solid var(--border); padding-top: 0.75rem;">
                <label style="margin-top: 0; font-size: 0.72rem; color: var(--text-dim);">Fighter Data</label>
                <label>{{ match.participant_a }} ‚Äî Image URL</label>
                <input type="text" name="fighter_a_image" value="{{ match.fighter_a_image or '' }}" placeholder="https://...">
                <div class="admin-edit-grid">
                    <div>
                        <label>Record</label>
                        <input type="text" name="fighter_a_record" value="{{ match.fighter_a_record or '' }}" placeholder="e.g. 45-12-0">
                    </div>
                    <div>
                        <label>Nationality</label>
                        <input type="text" name="fighter_a_nationality" value="{{ match.fighter_a_nationality or '' }}" placeholder="e.g. Netherlands">
                    </div>
                </div>
                <label style="margin-top: 0.75rem;">{{ match.participant_b }} ‚Äî Image URL</label>
                <input type="text" name="fighter_b_image" value="{{ match.fighter_b_image or '' }}" placeholder="https://...">
                <div class="admin-edit-grid">
                    <div>
                        <label>Record</label>
                        <input type="text" name="fighter_b_record" value="{{ match.fighter_b_record or '' }}" placeholder="e.g. 38-11-0">
                    </div>
                    <div>
                        <label>Nationality</label>
                        <input type="text" name="fighter_b_nationality" value="{{ match.fighter_b_nationality or '' }}" placeholder="e.g. Morocco">
                    </div>
                </div>
            </div>

            <input type="hidden" name="_action" id="action_{{ match.id }}" value="save">
            <div class="admin-actions">
                <button type="submit" class="btn btn-secondary btn-sm">Save</button>
                <button type="submit" class="btn btn-outline btn-sm" onclick="document.getElementById('action_{{ match.id }}').value='refetch_odds'">Re-fetch Odds</button>
                <button type="submit" class="btn btn-outline btn-sm" onclick="document.getElementById('action_{{ match.id }}').value='refetch_fighter_data'">Re-fetch Fighter Data</button>
            </div>
        </form>
        <div class="admin-actions" style="margin-top: 0.35rem;">
            <form method="post" action="{{ url_for('delete_match', pool_id=pool.id, match_id=match.id) }}">
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete this match?')">Delete</button>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{# --- Add match --- #}
<div class="section-title">Add Match</div>
<div class="card">
    <form method="post" action="{{ url_for('add_match', pool_id=pool.id) }}">
        <div class="inline-form">
            <input type="text" name="participant_a" placeholder="Fighter A" required style="flex: 2;">
            <input type="text" name="participant_b" placeholder="Fighter B" required style="flex: 2;">
            <input type="number" name="multiplier" value="1" min="1" placeholder="√ó" title="Multiplier" style="flex: 1; max-width: 5rem;">
            <button type="submit" class="btn btn-primary btn-sm">Add</button>
        </div>
    </form>
</div>

{# --- CSV Upload --- #}
<div class="section-title">Import Matches from CSV</div>
<div class="card">
    <p style="font-size: 0.82rem; color: var(--text-muted); margin-bottom: 0.75rem;">
        Upload a CSV to bulk-import matches with optional odds and fighter data.
        <a href="{{ url_for('csv_template', pool_id=pool.id) }}">Download template</a>
    </p>
    <div class="csv-schema">
        <div class="csv-schema-title">CSV columns</div>
        <div class="csv-schema-cols">
            <span class="csv-col required">fighter_a</span>
            <span class="csv-col required">fighter_b</span>
            <span class="csv-col optional">multiplier</span>
            <span class="csv-col optional">odds_a</span>
            <span class="csv-col optional">odds_b</span>
            <span class="csv-col optional">fighter_a_record</span>
            <span class="csv-col optional">fighter_a_nationality</span>
            <span class="csv-col optional">fighter_b_record</span>
            <span class="csv-col optional">fighter_b_nationality</span>
            <span class="csv-col optional">fighter_a_image</span>
            <span class="csv-col optional">fighter_b_image</span>
        </div>
        <p style="font-size: 0.72rem; color: var(--text-dim); margin-top: 0.4rem;">
            Only <strong>fighter_a</strong> and <strong>fighter_b</strong> are required. All other columns are optional.
            Missing fighter data will be auto-fetched from Wikipedia.
        </p>
    </div>
    <form method="post" action="{{ url_for('upload_csv', pool_id=pool.id) }}" enctype="multipart/form-data" style="margin-top: 0.75rem;">
        <div class="inline-form">
            <input type="file" name="csv_file" accept=".csv" required style="flex: 1; font-size: 0.85rem;">
            <button type="submit" class="btn btn-primary btn-sm">Upload CSV</button>
        </div>
    </form>
</div>

{# --- Link to settings --- #}
<p class="mt-2 text-center">
    <a href="{{ url_for('pool_settings', pool_id=pool.id) }}" style="font-size: 0.82rem;">Pool Settings (Name, Delete Pool)</a>
</p>

</div>{# end tab-pool #}

{% endblock %}

{% block scripts %}
<script>
function switchTab(tabId) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelector('[data-tab="' + tabId + '"]').classList.add('active');
    document.getElementById(tabId).classList.add('active');
    history.replaceState(null, '', '#' + tabId);
}

function toggleAdminCard(header) {
    const card = header.closest('.admin-match-card');
    const wasExpanded = card.classList.contains('expanded');
    // Collapse all
    document.querySelectorAll('.admin-match-card').forEach(c => c.classList.remove('expanded'));
    // Expand clicked (if it wasn't already open)
    if (!wasExpanded) {
        card.classList.add('expanded');
    }
}

function togglePick(btn, matchId, pick) {
    const hidden = document.getElementById('pick_' + matchId);
    const parent = btn.closest('.fighters');
    parent.querySelectorAll('.fighter-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    hidden.value = pick;
}

function copyLink() {
    const input = document.getElementById('pool-url');
    input.select();
    navigator.clipboard.writeText(input.value).then(() => {
        const btn = input.parentElement.querySelector('.btn');
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy', 2000);
    });
}

function showSignInToast() {
    // Remove any existing sign-in toast to avoid stacking
    var existing = document.getElementById('signin-toast');
    if (existing) existing.remove();
    var container = document.querySelector('.flash-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'flash-container';
        document.querySelector('.container').prepend(container);
    }
    var toast = document.createElement('div');
    toast.id = 'signin-toast';
    toast.className = 'flash info';
    toast.dataset.flashType = 'info';
    toast.innerHTML = '<a href="{{ url_for('signin', pool_id=pool.id) }}">Sign in</a> or <a href="{{ url_for('join_pool', pool_id=pool.id) }}">join the pool</a> to make your predictions.' +
        '<button class="flash-dismiss" onclick="dismissFlash(this)" aria-label="Dismiss">&times;</button>';
    container.appendChild(toast);
    setTimeout(function() {
        toast.classList.add('fade-out');
        setTimeout(function() {
            toast.remove();
            if (container && !container.querySelector('.flash')) container.remove();
        }, 400);
    }, 4000);
}

// Auto-switch to Pool tab if hash is present
if (window.location.hash === '#tab-pool') {
    switchTab('tab-pool');
}
</script>
{% endblock %}
