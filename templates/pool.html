{% extends "base.html" %}

{% block title %}{{ pool.name }}{% endblock %}
{% block header %}{{ pool.name }}{% endblock %}
{% block subheader %}
    <span class="status-badge status-{{ pool.status }}">{{ pool.status }}</span>
    {% if pool.description %}<br>{{ pool.description }}{% endif %}
{% endblock %}

{% block content %}

{# --- Share link --- #}
<div class="pool-link-box">
    <input type="text" id="pool-url" value="{{ request.url_root }}pool/{{ pool.id }}" readonly onclick="this.select()">
    <button class="btn btn-outline btn-sm" onclick="copyLink()">Copy</button>
</div>

{# --- Winner banner --- #}
{% if pool.status == 'finished' and leaderboard %}
<div class="winner-banner">
    <div class="trophy">üèÜ</div>
    <h2>{{ leaderboard[0].display_name }} wins!</h2>
    <p>{{ leaderboard[0].score() }} pts</p>
</div>
{% endif %}

{# --- Action bar --- #}
<div class="actions-bar">
    {% if not me %}
        <a href="{{ url_for('join_pool', pool_id=pool.id) }}" class="btn btn-primary btn-sm">Join Pool</a>
        <a href="{{ url_for('signin', pool_id=pool.id) }}" class="btn btn-outline btn-sm">Sign Back In</a>
    {% else %}
        <span class="signed-in-as">Signed in as <strong>{{ me.display_name }}</strong></span>
    {% endif %}

    <a href="{{ url_for('pool_settings', pool_id=pool.id) }}" class="btn btn-outline btn-sm ml-auto">Settings</a>
</div>

{# --- Pool status controls --- #}
<div class="actions-bar">
    {% if pool.status == 'open' %}
        <form method="post" action="{{ url_for('lock_pool', pool_id=pool.id) }}">
            <button type="submit" class="btn btn-secondary btn-sm" onclick="return confirm('Lock the pool? No more predictions will be allowed.')">Lock Predictions</button>
        </form>
    {% elif pool.status == 'locked' %}
        <form method="post" action="{{ url_for('reopen_pool', pool_id=pool.id) }}">
            <button type="submit" class="btn btn-outline btn-sm">Reopen for Predictions</button>
        </form>
        {% if pool.all_results_entered %}
        <form method="post" action="{{ url_for('finish_pool', pool_id=pool.id) }}">
            <button type="submit" class="btn btn-primary btn-sm" onclick="return confirm('Finish the pool and declare a winner?')">Finish &amp; Declare Winner</button>
        </form>
        {% endif %}
    {% elif pool.status == 'finished' %}
        <form method="post" action="{{ url_for('reopen_pool', pool_id=pool.id) }}">
            <button type="submit" class="btn btn-outline btn-sm">Reopen Pool</button>
        </form>
    {% endif %}
</div>

{# --- Matches + Predictions --- #}
{% if pool.matches %}
<div class="section-title">Matches</div>

{% if me and pool.status == 'open' %}
<form method="post" action="{{ url_for('save_predictions', pool_id=pool.id) }}">
{% endif %}

{% for match in pool.matches %}
<div class="match-card {% if match.result %}has-result{% endif %}">
    <div class="match-header">
        <span class="match-label">Match {{ loop.index }}</span>
        <span class="match-points">√ó{{ match.multiplier }}</span>
    </div>
    <div class="fighters">
        {% set my_pick = my_predictions.get(match.id) %}

        {# Fighter A button #}
        {% if me and pool.status == 'open' %}
            <button type="button" class="fighter-btn {% if my_pick == 'a' %}selected{% endif %}"
                    onclick="togglePick(this, '{{ match.id }}', 'a')">
                <div class="fighter-cell">
                    {% if match.fighter_a_image %}
                        <img src="{{ match.fighter_a_image }}" alt="{{ match.participant_a }}" class="fighter-photo">
                    {% endif %}
                    <span>{{ match.fighter_a_flag }} {{ match.participant_a }}</span>
                    {% if match.odds_a %}
                        <span class="odds-badge">{{ '%.2f'|format(match.odds_a) }}</span>
                    {% endif %}
                    {% if match.fighter_a_record %}
                        <span class="fighter-meta"><span class="record">{{ match.fighter_a_record }}</span></span>
                    {% endif %}
                </div>
            </button>
        {% else %}
            <div class="fighter-btn
                {% if match.result == 'a' %}winner-highlight{% endif %}
                {% if my_pick == 'a' and match.result == 'a' %}correct{% elif my_pick == 'a' and match.result and match.result != 'a' %}wrong{% elif my_pick == 'a' %}selected{% endif %}">
                <div class="fighter-cell">
                    {% if match.fighter_a_image %}
                        <img src="{{ match.fighter_a_image }}" alt="{{ match.participant_a }}" class="fighter-photo">
                    {% endif %}
                    <span>{{ match.fighter_a_flag }} {{ match.participant_a }}</span>
                    {% if match.odds_a %}
                        <span class="odds-badge">{{ '%.2f'|format(match.odds_a) }}</span>
                    {% endif %}
                    {% if match.fighter_a_record %}
                        <span class="fighter-meta"><span class="record">{{ match.fighter_a_record }}</span></span>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <span class="vs">VS</span>

        {# Fighter B button #}
        {% if me and pool.status == 'open' %}
            <button type="button" class="fighter-btn {% if my_pick == 'b' %}selected{% endif %}"
                    onclick="togglePick(this, '{{ match.id }}', 'b')">
                <div class="fighter-cell">
                    {% if match.fighter_b_image %}
                        <img src="{{ match.fighter_b_image }}" alt="{{ match.participant_b }}" class="fighter-photo">
                    {% endif %}
                    <span>{{ match.fighter_b_flag }} {{ match.participant_b }}</span>
                    {% if match.odds_b %}
                        <span class="odds-badge">{{ '%.2f'|format(match.odds_b) }}</span>
                    {% endif %}
                    {% if match.fighter_b_record %}
                        <span class="fighter-meta"><span class="record">{{ match.fighter_b_record }}</span></span>
                    {% endif %}
                </div>
            </button>
        {% else %}
            <div class="fighter-btn
                {% if match.result == 'b' %}winner-highlight{% endif %}
                {% if my_pick == 'b' and match.result == 'b' %}correct{% elif my_pick == 'b' and match.result and match.result != 'b' %}wrong{% elif my_pick == 'b' %}selected{% endif %}">
                <div class="fighter-cell">
                    {% if match.fighter_b_image %}
                        <img src="{{ match.fighter_b_image }}" alt="{{ match.participant_b }}" class="fighter-photo">
                    {% endif %}
                    <span>{{ match.fighter_b_flag }} {{ match.participant_b }}</span>
                    {% if match.odds_b %}
                        <span class="odds-badge">{{ '%.2f'|format(match.odds_b) }}</span>
                    {% endif %}
                    {% if match.fighter_b_record %}
                        <span class="fighter-meta"><span class="record">{{ match.fighter_b_record }}</span></span>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {% if me and pool.status == 'open' %}
            <input type="hidden" name="match_{{ match.id }}" id="pick_{{ match.id }}" value="{{ my_pick or '' }}">
        {% endif %}
    </div>

    {# Potential score display #}
    {% if match.odds_a or match.odds_b %}
    <div class="potential-score">
        {% if match.odds_a %}{{ match.participant_a }}: {{ match.potential_score('a') }} pts{% endif %}
        {% if match.odds_a and match.odds_b %} ¬∑ {% endif %}
        {% if match.odds_b %}{{ match.participant_b }}: {{ match.potential_score('b') }} pts{% endif %}
    </div>
    {% endif %}

    {# Prediction counts #}
    {% set summary = pred_summary.get(match.id, {'a': 0, 'b': 0}) %}
    {% if pool.participants|length > 0 %}
    <div class="picks-detail">
        {{ summary.a }} picked {{ match.participant_a }} ¬∑ {{ summary.b }} picked {{ match.participant_b }}
    </div>
    {% endif %}

    {# Result display or entry #}
    {% if match.result %}
        <div class="picks-detail">
            <strong>Winner:
            {% if match.result == 'a' %}{{ match.participant_a }}
            {% elif match.result == 'b' %}{{ match.participant_b }}
            {% else %}Draw{% endif %}</strong>
            ¬∑ <form method="post" action="{{ url_for('clear_result', pool_id=pool.id, match_id=match.id) }}" style="display:inline;">
                <button type="submit" class="btn btn-outline btn-sm" style="padding:0.15rem 0.4rem; font-size:0.7rem; vertical-align: middle;">Clear</button>
            </form>
        </div>
    {% elif pool.status in ('locked', 'finished') %}
        <div class="result-btns">
            <form method="post" action="{{ url_for('enter_result', pool_id=pool.id, match_id=match.id) }}">
                <input type="hidden" name="result" value="a">
                <button type="submit" class="btn btn-outline btn-sm">{{ match.participant_a }} wins</button>
            </form>
            <form method="post" action="{{ url_for('enter_result', pool_id=pool.id, match_id=match.id) }}">
                <input type="hidden" name="result" value="b">
                <button type="submit" class="btn btn-outline btn-sm">{{ match.participant_b }} wins</button>
            </form>
        </div>
    {% endif %}
</div>
{% endfor %}

{% if me and pool.status == 'open' %}
    <button type="submit" class="btn btn-primary btn-full mt-1">Save My Predictions</button>
</form>
{% endif %}

{% else %}
<p class="mt-2" style="color: var(--text-muted);">No matches yet. <a href="{{ url_for('pool_settings', pool_id=pool.id) }}">Add some matches</a> to get started.</p>
{% endif %}

{# --- All picks (visible when locked/finished) --- #}
{% if pool.status in ('locked', 'finished') and pool.participants and pool.matches %}
<div class="section-title">Everyone's Picks</div>
<div class="overflow-x">
<table>
    <thead>
        <tr>
            <th style="text-align:left;">Match</th>
            {% for p in leaderboard %}
            <th>{{ p.display_name }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for match in pool.matches %}
        <tr>
            <td>{{ match.participant_a }} vs {{ match.participant_b }}</td>
            {% for p in leaderboard %}
                {% set pick = all_predictions.get(p.id, {}).get(match.id) %}
                <td>
                    {% if pick == 'a' %}
                        <span {% if match.result == 'a' %}style="color:var(--green);font-weight:700;"{% elif match.result and match.result != 'a' %}style="color:var(--red-wrong);text-decoration:line-through;"{% endif %}>
                            {{ match.participant_a }}
                        </span>
                    {% elif pick == 'b' %}
                        <span {% if match.result == 'b' %}style="color:var(--green);font-weight:700;"{% elif match.result and match.result != 'b' %}style="color:var(--red-wrong);text-decoration:line-through;"{% endif %}>
                            {{ match.participant_b }}
                        </span>
                    {% else %}
                        ‚Äî
                    {% endif %}
                </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>
{% endif %}

{# --- Leaderboard --- #}
{% if pool.participants %}
<div class="section-title">Leaderboard</div>
<div class="leaderboard">
    {% for p in leaderboard %}
    <div class="leaderboard-entry">
        <span class="leaderboard-rank">
            {% if loop.index == 1 and pool.status == 'finished' %}üèÜ{% else %}#{{ loop.index }}{% endif %}
        </span>
        <span class="leaderboard-name">
            {{ p.display_name }}
            {% if me and p.id == me.id %}<span class="you">(you)</span>{% endif %}
        </span>
        <span class="leaderboard-score">{{ p.score() }} pts</span>
    </div>
    {% endfor %}
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
function togglePick(btn, matchId, pick) {
    const hidden = document.getElementById('pick_' + matchId);
    const parent = btn.closest('.fighters');
    parent.querySelectorAll('.fighter-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    hidden.value = pick;
}

function copyLink() {
    const input = document.getElementById('pool-url');
    input.select();
    navigator.clipboard.writeText(input.value).then(() => {
        const btn = input.parentElement.querySelector('.btn');
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy', 2000);
    });
}
</script>
{% endblock %}
